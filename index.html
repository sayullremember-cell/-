<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Tree - Ultimate Compatibility</title>
    
    <!-- 引入 Google 字体 (如果不加载也不影响运行) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Times+New+Roman&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Times New Roman', serif; color: #fceea7; }
        
        /* UI 样式 */
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        h1 { 
            font-family: 'Cinzel', serif; font-size: 40px; text-align: center; margin-top: 20px; 
            color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); 
        }
        .controls { position: absolute; bottom: 30px; width: 100%; text-align: center; pointer-events: auto; }
        button { 
            background: #000; color: #d4af37; border: 1px solid #d4af37; padding: 10px 20px; 
            font-family: 'Cinzel', serif; cursor: pointer; font-size: 16px; 
        }
        button:hover { background: #222; }
        
        /* 调试信息 */
        #debug { position: fixed; top: 0; left: 0; color: lime; background: rgba(0,0,0,0.5); padding: 5px; z-index: 9999; }
    </style>

    <!-- 1. 使用国内 BootCDN 加载 Three.js (r128版本，支持全局变量) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <!-- 屏幕左上角的调试器 -->
    <div id="debug">System Check: Waiting for script...</div>

    <div id="ui-container">
        <h1>Merry Christmas</h1>
        <div class="controls">
            <button onclick="changeMode()">SWITCH MODE (Tree / Scatter)</button>
            <p style="font-size: 12px; color: #888;">Drag Mouse to Rotate | Click Button to Explode</p>
        </div>
    </div>

    <!-- 核心逻辑脚本 (不使用 module，最原始的 JS) -->
    <script>
        // --- 错误捕捉 ---
        window.onerror = function(msg, url, line) {
            document.getElementById('debug').innerHTML = "❌ Error: " + msg;
        };

        // --- 核心程序 ---
        function initApp() {
            var debug = document.getElementById('debug');
            
            // 1. 检查 Three.js 是否加载
            if (typeof THREE === 'undefined') {
                debug.innerHTML = "❌ Critical Error: Three.js library loaded failed! (Network Blocked)";
                return;
            }
            debug.innerHTML = "✅ Engine Loaded. Starting Scene...";

            // 2. 创建场景
            var scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            // 3. 创建相机
            var camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 40);

            // 4. 创建渲染器
            var renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            // 5. 灯光
            var ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            var point = new THREE.PointLight(0xd4af37, 2, 50);
            point.position.set(0, 10, 10);
            scene.add(point);

            // 6. 创建粒子 (圣诞树)
            var particles = [];
            var geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            var materialGold = new THREE.MeshStandardMaterial({ color: 0xd4af37, roughness: 0.3 });
            var materialRed = new THREE.MeshStandardMaterial({ color: 0xaa0000, roughness: 0.3 });
            var group = new THREE.Group();
            scene.add(group);

            var total = 1500;
            for(var i=0; i<total; i++) {
                var mat = Math.random() > 0.5 ? materialGold : materialRed;
                var mesh = new THREE.Mesh(geometry, mat);
                
                // 树形结构坐标计算
                var t = i / total;
                var angle = t * 50 * Math.PI;
                var radius = 12 * (1 - t);
                var h = t * 30 - 15;
                
                var x = Math.cos(angle) * radius;
                var z = Math.sin(angle) * radius;
                var y = h;

                mesh.position.set(x, y, z);
                
                // 存储原始位置用于动画
                mesh.userData = {
                    treePos: new THREE.Vector3(x, y, z),
                    scatterPos: new THREE.Vector3((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*50),
                    speed: Math.random() * 0.02
                };

                group.add(mesh);
                particles.push(mesh);
            }

            // 7. 动画循环
            var mode = 'TREE';
            var time = 0;
            var mouseX = 0;
            var mouseY = 0;

            function animate() {
                requestAnimationFrame(animate);
                time += 0.01;

                // 旋转整个组
                group.rotation.y += 0.002;
                group.rotation.y += (mouseX * 0.05 - group.rotation.y) * 0.1;
                group.rotation.x += (mouseY * 0.05 - group.rotation.x) * 0.1;

                // 粒子动画
                for(var i=0; i<particles.length; i++) {
                    var p = particles[i];
                    var target = (mode === 'TREE') ? p.userData.treePos : p.userData.scatterPos;
                    
                    // 简单的线性插值移动
                    p.position.x += (target.x - p.position.x) * 0.05;
                    p.position.y += (target.y - p.position.y) * 0.05;
                    p.position.z += (target.z - p.position.z) * 0.05;
                    
                    p.rotation.x += 0.02;
                    p.rotation.y += 0.02;
                }

                renderer.render(scene, camera);
            }
            animate();
            debug.innerHTML = "✅ Running! (Mode: " + mode + ")";

            // 8. 交互事件
            window.changeMode = function() {
                mode = (mode === 'TREE') ? 'SCATTER' : 'TREE';
                debug.innerHTML = "✅ Mode switched to: " + mode;
            };

            window.addEventListener('mousemove', function(e) {
                mouseX = (e.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(e.clientY / window.innerHeight) * 2 + 1;
            });

            window.addEventListener('resize', function() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // 启动程序
        initApp();

    </script>
</body>
</html>
